<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" 
"http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="StockDao">



	<!-- 查询所有合同 -->
	<select id="contractlist" parameterType="Dto" resultType="Fc_contractPO">
		SELECT
		id_,platform_id_,status_
		FROM fc_contract  
		LIMIT #{limit} OFFSET #{offset}  
	</select>
	<!-- 统计所有应收已收 -->
	<select id="countReceivableReceived" parameterType="Dto"
		resultType="Dto">
		SELECT contract_id_,
		COALESCE(SUM(receivable_amount_),0) AS
		sum_receivable_,
		COALESCE(SUM(received_amount_),0) AS
		sum_received_amount_
		FROM fc_book_subject
		<where>

			contract_id_ in
			<foreach collection="listContract" item="contract" open="("
				close=")" separator=",">
				#{contract.id_}
			</foreach>

		</where>
		GROUP BY contract_id_

	</select>



	<!-- 查询“剩余”需要统计的分期ID -->
	<select id="getStagingByStatus" parameterType="Dto" resultType="Dto">
		SELECT id_
		FROM fc_staging
		<where>

			contract_id_ in
			<foreach collection="listContract" item="contract" open="("
				close=")" separator=",">
				#{contract.id_}
			</foreach>


			AND status_ =#{status}

		</where>
	</select>

	<!-- 统计合同分期的“剩余” -->
	<select id="countResidual" parameterType="Dto" resultType="Dto">
		SELECT contract_id_,
		COALESCE(SUM(receivable_amount_),0) AS
		sum_receivable_
		FROM
		fc_book_subject 
		<where>

			staging_id_ in (SELECT id_ FROM fc_staging WHERE  	contract_id_ in
			<foreach collection="listContract" item="contract" open="("
				close=")" separator=",">
				#{contract.id_}
			</foreach>


			AND status_ =#{status}
			)
		</where>
		GROUP BY contract_id_

	</select>

	<!-- 统计状态分期数 -->
	<select id="countStaging" parameterType="Dto" resultType="Dto">
		SELECT
		contract_id_,
		COALESCE(COUNT(id_),0) AS count_staging_ FROM
		fc_staging
		<where>

			contract_id_ in
			<foreach collection="listContract" item="contract" open="("
				close=")" separator=",">
				#{contract.id_}
			</foreach>
			AND status_ =#{status}
		</where>
		GROUP BY contract_id_

	</select>
	<!-- 统计逾期天数 -->
	<select id="countOverdueDay" parameterType="Dto" resultType="Dto">
		SELECT contract_id_,COALESCE(MAX(DATEDIFF(NOW(),billing_date_)),0) AS
		count_overdue_day_
		FROM fc_staging
		<where>

			contract_id_ in
			<foreach collection="listContract" item="contract" open="("
				close=")" separator=",">
				#{contract.id_}
			</foreach>
			AND status_ =#{status}
		</where>
		GROUP BY contract_id_
	</select>



	<!-- 根据合同科目统计应收，已收 -->
	<select id="categoryReceivableReceived" parameterType="Dto"
		resultType="Dto">
		SELECT
		contract_id_,category_id_,COALESCE(sum(receivable_amount_),0) as
		sum_receivable_amount_ ,
		COALESCE(sum(received_amount_),0) as
		sum_received_amount_
		FROM fc_book_subject
		<where>

			contract_id_ in
			<foreach collection="stockmap" item="stock" index="key" open="("
				close=")" separator=",">
				#{key}
			</foreach>
		</where>
		GROUP BY
		contract_id_,category_id_
	</select>

	<!-- 科目“剩余” -->
	<select id="categoryResidual" parameterType="Dto" resultType="Dto">

		SELECT concat(contract_id_,"_",category_id_) as key_,
		contract_id_,category_id_,COALESCE(sum(receivable_amount_),0)
		as
		sum_receivable_amount_
		FROM fc_book_subject
		<where>
	staging_id_ in (SELECT id_ FROM fc_staging WHERE   status_ =#{status} AND	contract_id_ in
			<foreach collection="stockmap" item="stock" index="key" open="("
				close=")" separator=",">
				#{key}
			</foreach>

			)
		</where>
		GROUP BY
		contract_id_,category_id_
	</select>




	<!-- 根据合同分期计应收，已收 -->
	<select id="stagingReceivableReceived" parameterType="Dto"
		resultType="Dto">
		SELECT
		contract_id_,staging_id_,COALESCE(sum(receivable_amount_),0) as
		sum_receivable_amount_ ,
		COALESCE(sum(received_amount_),0) as
		sum_received_amount_
		FROM fc_book_subject
		<where>

			contract_id_ in
			<foreach collection="stockmap" item="stock" index="key" open="("
				close=")" separator=",">
				#{key}
			</foreach>
		</where>
		GROUP BY
		contract_id_,staging_id_
	</select>


	<!-- 根据合同ID查询分期 -->
	<select id="stagingList" parameterType="Dto" resultType="Dto">
		SELECT id_,contract_id_,no_,billing_date_,status_,DATEDIFF(NOW(),billing_date_) AS
		count_overdue_day_
		FROM fc_staging
		<where>

			contract_id_ in
			<foreach collection="stockmap" item="stock" index="key" open="("
				close=")" separator=",">
				#{key}
			</foreach>
		</where>
	</select>


	<!-- 查询所有冲销账簿 -->
	<select id="subjectList" parameterType="Dto" resultType="Dto">
		SELECT id_,
		contract_id_,staging_id_,category_id_,
		received_amount_,receivable_amount_
		FROM fc_book_subject
		<where>
			contract_id_ in
			<foreach collection="stockmap" item="stock" index="key" open="("
				close=")" separator=",">
				#{key}
			</foreach>
		</where>
	</select>




	<!-- 查询科目 -->
	<select id="categoryList" parameterType="Dto" resultType="Dto">
		SELECT
		id_,name_,type_,enabled_,remark_ FROM fc_financial_category
	</select>



<select id="categoryReceivableReceivedByContractId" parameterType="Dto"
		resultType="Dto">
		SELECT
		fc_book_subject.contract_id_,fc_book_subject.category_id_,COALESCE(sum(receivable_amount_),0) as
		sum_receivable_amount_ ,
		COALESCE(sum(received_amount_),0) as
		sum_received_amount_
		FROM fc_book_subject
		WHERE
		fc_book_subject.contract_id_ = #{contract_id_}
		
		GROUP BY
		fc_book_subject.contract_id_,fc_book_subject.category_id_
	</select>

	<select id="categoryResidualByContractId" parameterType="Dto" resultType="Dto">

		SELECT concat(fc_book_subject.contract_id_,"_",fc_book_subject.category_id_) as key_,
		fc_book_subject.contract_id_,fc_book_subject.category_id_,COALESCE(sum(receivable_amount_),0)
		as
		sum_receivable_amount_
		FROM fc_book_subject 
		INNER JOIN fc_staging on fc_staging.id_=fc_book_subject.staging_id_
		WHERE
			fc_book_subject.contract_id_ = #{contract_id_} 
			AND fc_staging.status_=#{status_}
	
		GROUP BY
		fc_book_subject.contract_id_,fc_book_subject.category_id_

	</select>
	
	
	<select id="stagingReceivableReceivedByContractId" parameterType="Dto"
		resultType="Dto">
		SELECT
		contract_id_,staging_id_,COALESCE(sum(receivable_amount_),0) as
		sum_receivable_amount_ ,
		COALESCE(sum(received_amount_),0) as
		sum_received_amount_
		FROM fc_book_subject
		<where>

			contract_id_ =#{contract_id_}
		</where>
		GROUP BY
		contract_id_,staging_id_
	</select>
	<select id="stagingListByContractId" parameterType="Dto" resultType="Dto">
		SELECT id_,contract_id_,no_,billing_date_,status_,DATEDIFF(NOW(),billing_date_) AS
		count_overdue_day_
		FROM fc_staging
		<where>

			contract_id_ =#{contract_id_}
			
		</where>
	</select>
	
	<!-- 查询所有冲销账簿 -->
	<select id="subjectListByContractId" parameterType="Dto" resultType="Dto">
		SELECT id_,
		contract_id_,staging_id_,category_id_,
		received_amount_,receivable_amount_
		FROM fc_book_subject
		<where>
			contract_id_=#{contract_id_}
		</where>
	</select>
</mapper>