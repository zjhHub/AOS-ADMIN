<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" 
"http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="callBackDao">

	<select id="getchargebackOrderList" parameterType="Dto" resultType="Fc_chargeback_orderPO">

		SELECT
		<include refid="aos.fc.dao.Fc_chargeback_orderDao.column" />
		FROM fc_chargeback_order
		where

			(location_=#{location_} AND #{next_interact_time_} >= next_interact_time_)
			or 
			(location_=#{location_} AND next_interact_time_ is null)

		
	</select>
	<select id="getAcceptedList" parameterType="Dto" resultType="Dto">

		SELECT
		<include refid="aos.fc.dao.Fc_chargeback_acceptedDao.column2" />,
	
		  fc_chargback_accepted_result.chargeback_status_,  <!-- chargeback_status_ -->
		  fc_chargback_accepted_result.chargebacked_amount_,  <!-- chargebacked_amount_ -->
		  fc_chargback_accepted_result.response_code_,  <!-- response_code_ -->
		  fc_chargback_accepted_result.response_summary_,  <!-- response_summary_ -->
		  fc_chargback_accepted_result.response_msg_templet_,  <!-- response_msg_templet_ -->
		  fc_chargback_accepted_result.first_callback_time_,  <!-- first_callback_time_ -->
		  fc_chargback_accepted_result.callback_content_,  <!-- callback_content_ -->
		  fc_chargback_accepted_result.next_callback_time_,  <!-- next_callback_time_ -->
		  fc_chargback_accepted_result.cur_callback_count  <!-- cur_callback_count -->
		FROM fc_chargeback_accepted 
		INNER JOIN
	fc_chargback_accepted_result ON fc_chargeback_accepted.id_=fc_chargback_accepted_result.chargeback_accepted_id_ 
		where

			(fc_chargeback_accepted.location_=#{location_} AND #{next_callback_time_} >= fc_chargback_accepted_result.next_callback_time_)
			or 
			(fc_chargeback_accepted.location_=#{location_} AND 	  fc_chargback_accepted_result.next_callback_time_ is null)

		
	</select>
	
	<select id="selecyAcceptedOne" parameterType="Dto" resultType="Dto">

		SELECT
		<include refid="aos.fc.dao.Fc_chargeback_acceptedDao.column2" />,
	
		  fc_chargback_accepted_result.chargeback_status_,  <!-- chargeback_status_ -->
		  fc_chargback_accepted_result.chargebacked_amount_,  <!-- chargebacked_amount_ -->
		  fc_chargback_accepted_result.response_code_,  <!-- response_code_ -->
		  fc_chargback_accepted_result.response_summary_,  <!-- response_summary_ -->
		  fc_chargback_accepted_result.response_msg_templet_,  <!-- response_msg_templet_ -->
		  fc_chargback_accepted_result.first_callback_time_,  <!-- first_callback_time_ -->
		  fc_chargback_accepted_result.callback_content_,  <!-- callback_content_ -->
		  fc_chargback_accepted_result.next_callback_time_,  <!-- next_callback_time_ -->
		  fc_chargback_accepted_result.cur_callback_count  <!-- cur_callback_count -->
		FROM fc_chargeback_accepted 
		INNER JOIN
	fc_chargback_accepted_result ON fc_chargeback_accepted.id_=fc_chargback_accepted_result.chargeback_accepted_id_ 
		where
fc_chargeback_accepted.id_=#{id_}
		
	</select>
	
	
	
	<!-- 根据主键修改数据持久化对象 -->
	<update id="updateByAcceptedId" parameterType="Dto">
		UPDATE fc_chargeback_order
		<set>
			
			<if test="location_ != null">
		          location_ = #{location_, jdbcType=INTEGER},  <!-- location_ -->
			</if>
			
		</set>
		WHERE  chargeback_accepted_id_ = #{chargeback_accepted_id_}
	</update>
	
	<!-- 根据Dto查询并返回数据持久化对象集合 -->
	<select id="selectAcceptedIdCount" parameterType="Dto" resultType="Dto">
			select group_.* from (

SELECT
	chargeback_accepted_id_,
	COALESCE(COUNT(chargeback_accepted_id_),0) AS count_,
	COALESCE(SUM(
		IF (
			fc_chargeback_order_result.order_result_status_ =1,fc_chargeback_order_result.trans_amount,0
		) 
	),0 )AS sum_
FROM
	fc_chargeback_order
INNER JOIN fc_chargeback_order_result ON fc_chargeback_order_result.id_ = fc_chargeback_order.id_
WHERE
		location_ in (3,5)
GROUP BY
	chargeback_accepted_id_

) as group_
INNER JOIN
	fc_chargback_accepted_result result_ ON group_.chargeback_accepted_id_=result_.chargeback_accepted_id_ 

WHERE 

	(  #{next_callback_time_} >= next_callback_time_)
			or 
			( next_callback_time_ is null)
		
	</select>
	
	

	
	
	<!-- 根据Dto查询并返回数据持久化对象集合 -->
	<select id="orderResultlist" parameterType="Dto" resultType="Fc_chargeback_order_resultPO">
		SELECT
			<include refid="aos.fc.dao.Fc_chargeback_order_resultDao.column" />	
		FROM fc_chargeback_order_result
		<where>
		       id_  in  (select id_ FROM fc_chargeback_order WHERE chargeback_accepted_id_=#{chargeback_accepted_id_})
		</where>	
	</select>
	
	
		
	
	
	
	<!-- 根据Dto查询并返回数据持久化对象集合 -->
	<select id="orderBean" parameterType="Dto" resultType="Dto">
			SELECT
	third.name_ AS third_channel,
	cb_order.third_channel_order_id_ AS order_id,
	CASE WHEN result.order_result_status_=1 THEN "成功"  ELSE "失败" END AS order_status,
result.trans_amount AS order_amount,
	cb_order.chargeback_amount_ AS trans_amount,
result.bank_echo_time_ AS bank_return_time,
result.request_time AS request_time,
result.response_time_ AS response_time,
result.third_channel_fee_ AS third_channel_fee,
result.third_channel_feedback_ AS feedback
FROM
	fc_chargeback_order cb_order
LEFT JOIN fc_third_channel third ON third.id_ = cb_order.routed_third_channel_id_ 
LEFT JOIN fc_chargeback_order_result result on result.id_=cb_order.id_ 
WHERE 
cb_order.chargeback_accepted_id_=#{id_} 
	</select>
	
	
		
	<!-- 根据Dto统计行数 -->
	<select id="exceptionRows" resultType="Integer" parameterType="Dto">
			select count(1) from fc_chargeback_order_exception 
WHERE order_id_ in (select id_ FROM fc_chargeback_order WHERE chargeback_accepted_id_=#{id_})

	</select>

</mapper>