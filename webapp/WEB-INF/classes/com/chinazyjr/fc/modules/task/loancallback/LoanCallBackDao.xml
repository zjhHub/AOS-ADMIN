<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" 
"http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="loancallBackDao">
	<!-- 获取已处理放款指令库 查询-->
	<!-- 根据Dto查询并返回数据持久化对象集合 -->
	<select id="selectAcceptedIdCount" parameterType="Dto" resultType="Dto">
			SELECT
	fc_loan_accepted_order.id_,
	fc_loan_accepted_order.async_callback_,
	fc_loan_accepted_order.contract_code_,
	fc_loan_accepted_order.reference_,
	fc_loan_accepted_order.platform_id_,
	fc_loan_accepted_order_result.next_callback_time_,
	fc_loan_accepted_order_result.cur_callback_count,
	COALESCE(COUNT(fc_loan_accepted_order.id_),0) AS count_,
	COALESCE(SUM(
		IF (
			fc_loan_accepted_order_result.order_result_status_ =1,fc_loan_accepted_order_result.trans_amount,0
		) 
	),0 )AS sum_
FROM
	fc_loan_accepted_order
INNER JOIN fc_loan_accepted_order_result ON fc_loan_accepted_order_result.id_ = fc_loan_accepted_order.id_
WHERE
		(fc_loan_accepted_order.location_ = #{location_} AND #{next_callback_time_} >= fc_loan_accepted_order_result.next_callback_time_)
		or 
		(fc_loan_accepted_order.location_=#{location_} AND fc_loan_accepted_order_result.next_callback_time_ is null) 
GROUP BY
	fc_loan_accepted_order.id_

	</select>
	
	<select id="selectLoanCallInfo" parameterType="Dto" resultType="Dto">
			SELECT
	fc_loan_accepted_order.id_,
	fc_loan_accepted_order.async_callback_,
	fc_loan_accepted_order.contract_code_,
	fc_loan_accepted_order.reference_,
	fc_loan_accepted_order.platform_id_,
	fc_loan_accepted_order_result.next_callback_time_,
	fc_loan_accepted_order_result.cur_callback_count,
	COALESCE(COUNT(fc_loan_accepted_order.id_),0) AS count_,
	COALESCE(SUM(
		IF (
			fc_loan_accepted_order_result.order_result_status_ =1,fc_loan_accepted_order_result.trans_amount,0
		) 
	),0 )AS sum_
FROM
	fc_loan_accepted_order
INNER JOIN fc_loan_accepted_order_result ON fc_loan_accepted_order_result.id_ = fc_loan_accepted_order.id_
WHERE
		(fc_loan_accepted_order_result.cur_callback_count >= #{cur_callback_count} AND #{next_callback_time_} >= fc_loan_accepted_order_result.next_callback_time_)
		or 
		(fc_loan_accepted_order_result.cur_callback_count >= #{cur_callback_count} AND fc_loan_accepted_order_result.next_callback_time_ is null) 
GROUP BY
	fc_loan_accepted_order.id_

	</select>
	
	
	<!-- 异步回调获取JSON查询 -->
	<select id="selecyAcceptedOne" parameterType="Dto" resultType="Dto">
		SELECT
			flao.id_ ,
			flaor.first_callback_time_ AS callback_first_time,
			flao.contract_code_ AS contract_code,
			flao.reference_ AS reference_id,
			flao.loan_account_ AS target_account,
			flao.async_callback_,
			flaor.order_result_status_ AS loan_status,
			<!-- CASE WHEN flaor.order_result_status_=1 THEN "成功"  ELSE "失败" END AS loan_status, -->
			flao.loan_amount_ AS loan_amount,
			flaor.trans_amount AS loaned_amount,
			flao.third_channel_order_id_ AS order_id,
			flaor.bank_echo_time_ AS bank_return_time,
			flaor.request_time AS request_time,
			flaor.response_time_ AS response_time,
			flaor.third_channel_fee_ AS third_channel_fee,
			flaor.third_channel_feedback_ AS feedback,
			flaor.cur_callback_count,
			flao.platform_id_,
			flao.routed_third_channel_id_,
			flaor.next_callback_time_ 
		FROM
			fc_loan_accepted_order flao
		LEFT JOIN fc_loan_accepted_order_result flaor ON flao.id_ = flaor.id_
		WHERE 
		flao.id_=#{id_}
		
	</select>
	
	<!-- 异步回调获取异常JSON查询  -->
	<select id="selecyexceptionOne" parameterType="Dto" resultType="Dto">
		SELECT
			fc_loan_order_exception.accepted_id_ AS accepted_id,
			fc_loan_order_exception.exception_time_,
			fc_loan_order_exception.response_code_,
			fc_loan_order_exception.response_msg_templet_,
			fc_loan_order_exception.response_summary_
		FROM
			fc_loan_order_exception
		WHERE 
			fc_loan_order_exception.accepted_id_ = #{accepted_id}
		
	</select>

</mapper>