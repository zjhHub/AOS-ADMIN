<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" 
"http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="enginePay">


	<select id="selectFcSignedAgree" parameterType="Dto" resultType="Fc_signed_agreementsPO">
	   SELECT id_,order_identity_id_,order_id_,third_channel_id_,contract_id_,sign_account_,sign_name_,sign_idcard_,
		  sign_cellphone_,start_date_,end_date_,sign_time_,third_channel_treaty_no_,status_ FROM fc_signed_agreements where status_ = 1
	   <if test="contract_id_ != null ">
		    AND contract_id_ = #{contract_id_}
	   </if>
	   ORDER BY end_date_ DESC LIMIT 1
	</select>
	
	<!-- 根据主键修改数据持久化对象 -->
	<update id="updateFcThirdChannelSeqByKey" parameterType="Dto">
		update fc_third_channel set order_sequence_ = order_sequence_ + 1 where id_ = #{id_};
	</update>
	
	<update id="updateChargebackOrderSendStatusByKey" parameterType="Dto">
		update fc_chargeback_order_send set sent_status_ = #{status} where id_ = #{orderSendId};
	</update>

	<update id="updateChargebockOrderLocationBykey" parameterType="Dto">
		update fc_chargeback_order set location_ = #{location_},change_time_ = #{change_time_} where id_ = #{chargeback_order_id}
	</update>
	
	<select id="selectSendCount" resultType="int" parameterType="Dto">
		SELECT count(*) FROM fc_chargeback_order_send where chargeback_order_id_ = #{chargeback_order_id_}
	</select>
	
	<select id="selectLogPo" parameterType="Dto" resultType="Fc_account_chargeback_logPO">
		SELECT
		    *
		FROM fc_account_chargeback_log
		where 
			chargeback_account_ = #{chargeback_account_}
			and third_channel_id_ = #{third_channel_id_}
			and substr(target_date_,1,10) = #{target_date_}
	</select>
	<update id="updateLogPoByKey" parameterType="Dto">
		update fc_account_chargeback_log
		<set>
			<if test="addSucceedTimes != null and addSucceedTimes != ''">
				chargeback_succeed_times_ = chargeback_succeed_times_ + 1,
			</if>
			<if test="addFailedTimes != null and addFailedTimes != ''">
				chargeback_failed_times_ = chargeback_failed_times_ + 1,
			</if>
			<if test="amount != null and amount != ''">
				today_total_chargebacked_amount_ = today_total_chargebacked_amount_ + #{amount}
			</if>
		</set>
		where chargeback_account_ = #{chargeback_account_}
			and third_channel_id_ = #{third_channel_id_}
			and target_date_ = #{target_date_}
	</update>
	
	<update id="updateChargebackOrderCheckStatusByKey"  parameterType="Dto">
		update fc_chargeback_order_check set checked_status_ = #{status} where id_ = #{orderCheckId};
	</update>
	
	<update id="updateChargebackOrderRequestId" parameterType="Dto">
		update fc_chargeback_order set third_channel_order_id_ = #{third_channel_order_id_} where id_ = #{chargeback_order_id}
	</update>

<!-- 	<select id="chargebackOrderListPage" parameterType="Dto" resultType="Dto"> -->
<!-- 			SELECT -->
<!-- 				fco.id_, -->
<!-- 				fco.created_time_, -->
<!-- 				ftc.name_ routed_third_channel_id_, -->
<!-- 				fco.location_, -->
<!-- 				fco.chargeback_accepted_id_, -->
<!-- 				fco.chargeback_amount_, -->
<!-- 				fbs.full_name_ chargeback_bank_id_, -->
<!-- 				fco.chargeback_account_, -->
<!-- 				fco.chargeback_name_, -->
<!-- 				fco.chargeback_idcard_, -->
<!-- 				fco.third_channel_order_id_, -->
<!-- 				fco.chargeback_cellphone_, -->
<!-- 				fcor.order_result_status_  -->
<!-- 			FROM -->
<!-- 				fc_chargeback_order fco, -->
<!-- 				fc_third_channel ftc, -->
<!-- 				fc_banks fbs, -->
<!-- 				fc_chargeback_accepted fca, -->
<!-- 				fc_chargeback_order_result fcor -->
<!-- 			WHERE -->
<!-- 				ftc.id_ = fco.routed_third_channel_id_ -->
<!-- 				and fbs.id_ = fco.chargeback_bank_id_ -->
<!-- 				and fco.chargeback_accepted_id_ = fca.id_  -->
<!-- 				and fco.id_ = fcor.id_ -->
<!-- 				<if test="location_ != null and location_ != ''"> -->
<!-- 					and fco.location_ = #{location_} -->
<!-- 				</if> -->
<!-- 	</select> -->


	<select id="chargebackOrderListPage" parameterType="Dto" resultType="Dto"> 
		select t.*,fcor.order_result_status_  from (
			SELECT
				fco.id_,
				fco.created_time_,
				ftc.name_ routed_third_channel_id_,
				fco.location_,
				fco.chargeback_accepted_id_,
				fco.chargeback_amount_,
				fbs.full_name_ chargeback_bank_id_,
				fco.chargeback_account_,
				fco.chargeback_name_,
				fco.chargeback_idcard_,
				fco.third_channel_order_id_,
				fco.chargeback_cellphone_
			FROM
				fc_chargeback_order fco,
				fc_third_channel ftc,
				fc_banks fbs,
				fc_chargeback_accepted fca
			WHERE
				ftc.id_ = fco.routed_third_channel_id_
				and fbs.id_ = fco.chargeback_bank_id_
				and fco.chargeback_accepted_id_ = fca.id_ and fco.location_ = '1'
				<if test="third_channel_order_id_ != null and third_channel_order_id_ != ''">
					and fco.third_channel_order_id_ = #{third_channel_order_id_}
				</if>
			) t LEFT JOIN fc_chargeback_order_result fcor
			on t.id_ = fcor.id_
	</select>


</mapper>