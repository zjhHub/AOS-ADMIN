<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" 
"http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="fc_third_channel_banks">

	<!-- 根据Dto查询并返回数据持久化对象集合 -->
	<select id="queryList" parameterType="Dto" resultType="Dto">
		select bank.*,chan.id_ thirdID,chan.code_,chan.name_,chan.success_permission_times_,chan.failure_permission_times_,chan.route_priority
		from fc_third_channel_bank bank,fc_third_channel chan where bank.third_channel_id_=chan.id_ 
		<if test="bank_id_ != null ">
		    AND bank.bank_id_ = #{bank_id_}  <!-- bank_id_ -->
		</if>
		<if test="is_enabled_ != null ">
		    AND bank.is_enabled_ = #{is_enabled_}  <!-- is_enabled_ -->
		</if>
		ORDER BY chan.route_priority DESC
		
	</select>
	
	<select id="queryFcSignedAgree" parameterType="Dto" resultType="Fc_signed_agreementsPO">
	   SELECT id_,
	   order_identity_id_,
	   order_id_,
	   third_channel_id_,
	   contract_id_,
	   sign_account_,
	   sign_name_,
	   sign_idcard_,
	   sign_cellphone_,
	   start_date_,
	   end_date_,
	   sign_time_,
	   third_channel_treaty_no_,
	   status_ 
	   FROM fc_signed_agreements 
		  where 
		  status_ = 1
	   <if test="sign_account_ != null ">
		    AND sign_account_ = #{sign_account_}
	   </if>
	   <if test="third_channel_id_ != null ">
		    AND third_channel_id_ = #{third_channel_id_}
	   </if>
	   <if test="contract_id_ != null ">
		    AND contract_id_ = #{contract_id_}
	   </if>
	   ORDER BY sign_time_ DESC LIMIT 1
	</select>
	
	
	<insert id="insertFcAcChargeback" useGeneratedKeys="true" keyProperty="id_" parameterType="Fc_account_chargeback_logPO">
		INSERT INTO fc_account_chargeback_log (
			chargeback_account_,third_channel_id_,target_date_,chargeback_failed_times_,chargeback_succeed_times_,today_total_chargebacked_amount_
		) SELECT
		<if test="chargeback_account_ != null and chargeback_account_ != ''">
	          #{chargeback_account_, jdbcType=VARCHAR}, <!-- chargeback_account_ -->
	    </if>
		<if test="third_channel_id_ != null">
	          #{third_channel_id_, jdbcType=INTEGER}, <!-- third_channel_id_ -->
	    </if>
		<if test="target_date_ != null">
	          #{target_date_, jdbcType=DATE}, <!-- target_date_ -->
	    </if>
		<if test="chargeback_failed_times_ != null">
	          #{chargeback_failed_times_, jdbcType=INTEGER}, <!-- chargeback_failed_times_ -->
	    </if>
		<if test="chargeback_succeed_times_ != null">
	          #{chargeback_succeed_times_, jdbcType=INTEGER}, <!-- chargeback_succeed_times_ -->
	    </if>
		<if test="today_total_chargebacked_amount_ != null">
	          #{today_total_chargebacked_amount_, jdbcType=NUMERIC} <!-- today_total_chargebacked_amount_ -->
	    </if>
	    FROM DUAL WHERE
		 NOT EXISTS (SELECT * FROM fc_account_chargeback_log where 1=1
			<if test="chargeback_account_ != null and chargeback_account_ != ''">
			     AND chargeback_account_ = #{chargeback_account_}
		   </if>
		   <if test="third_channel_id_ != null ">
			      AND third_channel_id_ = #{third_channel_id_}
			</if>
		   <if test="target_date_ != null ">
		 
			    <![CDATA[  AND target_date_ =  date_format(#{target_date_}, '%Y-%m-%d') ]]>   
		   </if>
		 )
	</insert>
	
</mapper>