<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" 
"http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="accountCheckingEveryday">
	<select id="accountCheckingEverydayPage" parameterType="Dto" resultType="Dto">
		SELECT
			fr.id_,
			fr.reconciliation_date_,
			fr.third_channel_id_,
			fr.type_,
			fr.status_,
			fr.today_order_counts_,
			fr.succeed_counts_,
			fr.unbalance_counts_,
			fr.only_our_side_counts_,
			fr.only_third_side_counts_,
			fr.patch_before_counts_,
			fr.file_path_
		FROM
			fc_reconciliation fr
<!-- 		LEFT JOIN  -->
<!-- 			fc_reconciliation_details frd -->
<!-- 		ON fr.id_ = frd.reconciliation_id_ -->
		<where>
			1 = 1
		<if test="start_created_time_ != null and start_created_time_ !='' "> 
			AND fr.reconciliation_date_ <![CDATA[ >= ]]> #{start_created_time_}  <!-- 开始日期 -->
		</if>
		
		<if test="end_created_time_ != null and end_created_time_ !='' ">
			AND fr.reconciliation_date_ <![CDATA[ <= ]]> CONCAT(#{end_created_time_},' 23:59:59')  <!-- 结束日期 -->
		</if>
		
		<if test="status_ != null and status_ != ''">
			AND fr.status_ = #{status_}
		</if>
		
		<if test="third_channel_id_ != null and third_channel_id_ != ''">
			AND fr.third_channel_id_ = #{third_channel_id_}
		</if>
		
<!-- 		<if test="result_ != null and result_ != ''"> -->
<!-- 			AND frd.result_ = #{result_} -->
<!-- 		</if> -->
		
		<if test="type_ != null and type_ != ''">
			AND fr.type_ = #{type_}
		</if>
		order by fr.reconciliation_date_ desc
		
		</where> 
 		
		
	</select>
	
	<!-- 当日扣款金额 -->
	<select id="accountCheckKkSumAmount" parameterType="Dto" resultType="Dto">
		SELECT 
			IFNULL(SUM(our_trans_amount_),0) kk_oursumtrans_amount,
			IFNULL(SUM(they_trans_amount_),0) kk_thirdsumtrans_amount
		FROM 
			fc_reconciliation_details fd,
			fc_reconciliation fr 
		WHERE 
			fd.reconciliation_id_ = fr.id_ AND fr.type_ = 1
		<if test="reconciliation_date_ != null and reconciliation_date_ != ''">
			AND fr.reconciliation_date_ = #{reconciliation_date_}
		</if>
	</select>
	
	<!-- 当日放款金额 -->
	<select id="accountCheckFkSumAmount" parameterType="Dto" resultType="Dto">
		SELECT 
			IFNULL(SUM(our_trans_amount_),0) fk_oursumtrans_amount,
			IFNULL(SUM(they_trans_amount_),0) fk_thirdsumtrans_amount
		FROM 
			fc_reconciliation_details fd,
			fc_reconciliation fr 
		WHERE 
			fd.reconciliation_id_ = fr.id_ AND fr.type_ = 2
		<if test="reconciliation_date_ != null and reconciliation_date_ != ''">
			AND fr.reconciliation_date_ = #{reconciliation_date_}
		</if>
	</select>
	
	<select id="accountSumTransAmount" parameterType="Dto" resultType="Dto">
		SELECT 
			IFNULL(SUM(our_trans_amount_),0) our_sumtrans_amount,
			IFNULL(SUM(they_trans_amount_),0) they_sumtrans_amount 
		FROM 
			fc_reconciliation_details fd,
			fc_reconciliation fr 
		WHERE 
			fd.reconciliation_id_ = fr.id_
		<if test="reconciliation_id_ != null and reconciliation_id_ != ''">
			AND fd.reconciliation_id_ = #{reconciliation_id_}
		</if>
		<if test="third_channel_id_ != null and third_channel_id_ != ''">
			AND fd.third_channel_id_ = #{third_channel_id_}
		</if>
		<if test="reconciliation_date_ != null and reconciliation_date_ != ''">
			AND fr.reconciliation_date_ = #{reconciliation_date_}
		</if>
		<if test="type_ != null and type_ != ''">
			AND fr.type_ = #{type_}
		</if>
	</select>
	
	<select id="accountcheckingeverydayDetails" parameterType="Dto" resultType="Dto">
		SELECT
			fr.id_,
			fr.reconciliation_date_,
			fr.third_channel_id_,
			fr.type_,
			fr.status_,
			fr.today_order_counts_,
			fr.succeed_counts_,
			fr.unbalance_counts_,
			fr.only_our_side_counts_,
			fr.only_third_side_counts_,
			fr.patch_before_counts_
		FROM
			fc_reconciliation fr
		WHERE
			1 = 1
		<if test="acceptID != null and acceptID != ''">
			AND fr.id_ = #{acceptID}
		</if>
	</select>
	

 	<select id="reconciliationDetailsCount" parameterType="Dto" resultType="Dto">
		SELECT
			count(*) as count
		FROM
			fc_reconciliation_details 
			where 1='1' and reconciliation_id_ = #{acceptID} 	
	</select>
	<!-- 	当日订单 -->
	<select id="reconciliationDetailsPage" parameterType="Dto" resultType="Dto">
	<!-- 	select t.* from (
			(select * from fc_reconciliation_details where reconciliation_id_ = #{acceptID} and result_ = 3 order by id_ asc)
			union all
			(select * from fc_reconciliation_details where reconciliation_id_ = #{acceptID} and result_ = 4 order by id_ asc)
			union all
			(select * from fc_reconciliation_details where reconciliation_id_ = #{acceptID} and result_ = 2 order by id_ asc)
			union all
			(select * from fc_reconciliation_details where reconciliation_id_ = #{acceptID} and result_ = 1 order by id_ asc)
		) as t  -->
		select 	
		  id_,
		  order_id_,
		  reconciliation_id_, 
		  third_channel_id_,
		  type_, 
		  result_,  
		  our_order_id_, 
		  our_sent_time_, 
		  our_trans_amount_, 
		  our_third_channel_fee_, 
		  they_order_id_,  
		  they_settled_time_,  
		  they_trans_amount_, 
		  they_third_channel_fee_, 
		  interference_status_, 
		  created_time_
		 from fc_reconciliation_details  where 
		 <if test="acceptID != null and acceptID != ''">
			reconciliation_id_ = #{acceptID}
		</if>
		 <if test="result_ != null and result_ != ''">
			and result_ = #{result_}
		</if>
		   order by result_  ASC , id_ ASC
	</select>
	
	
	
	<select id="reconciliationUnusualDetailsPage" parameterType="Dto" resultType="Dto">
		select 	
		  id_,
		  order_id_,
		  reconciliation_id_, 
		  third_channel_id_,
		  type_, 
		  result_,  
		  our_order_id_, 
		  our_sent_time_, 
		  our_trans_amount_, 
		  our_third_channel_fee_, 
		  they_order_id_,  
		  they_settled_time_,  
		  they_trans_amount_, 
		  they_third_channel_fee_, 
		  interference_status_, 
		  created_time_
		 from fc_reconciliation_details  where  result_ in ( '1', '2', '3' )
		 <if test="acceptID != null and acceptID != ''">
			and  reconciliation_id_ = #{acceptID}
		</if> 
		   order by result_  ASC , id_ ASC
	</select>
	
<!-- 	补录前 -->
<!-- 	<select id="formerReconciliationDetailsPage" parameterType="Dto" resultType="Dto">
		SELECT
		  frrd.id_,  
		  frrd.reconciliation_id_, 
		  frrd.reconciliation_detail_id_,
		  frrd.origin_result_, 
		  frrd.next_result_,  
		  frrd.they_order_id_,  
		  frrd.they_settled_time_, 
		  frrd.they_trans_amount_,  
		  frrd.they_third_channel_fee_,  

		  frd.our_order_id_,
		  frd.our_sent_time_,
		  frd.our_trans_amount_,
		  frd.our_third_channel_fee_,
		  frd.interference_status_,

		  fr.reconciliation_date_
		FROM
			fc_reconciliation_repair_detail frrd
		LEFT JOIN fc_reconciliation_details frd ON frd.id_  =  frrd.reconciliation_detail_id_
		LEFT JOIN fc_reconciliation fr ON frd.reconciliation_id_ = fr.id_
		WHERE
			frrd.origin_result_ IN (1, 2)
		AND frd.reconciliation_id_  = #{acceptID}
	</select> -->
	
	
	
	<!-- 	补录前 -->
	<select id="formerReconciliationDetailsPage" parameterType="Dto" resultType="Dto">
		SELECT
			frd.id_,
			frd.reconciliation_id_,
			frd.order_id_,
			frd.type_,
			frd.result_,
			frd.our_order_id_,
			frd.our_sent_time_,
			frd.our_trans_amount_,
			frd.our_third_channel_fee_,
			frd.they_order_id_,
			frd.they_settled_time_,
			frd.they_trans_amount_,
			frd.they_third_channel_fee_,
			frd.interference_status_,
			fr.reconciliation_date_,
			frrd.reconciliation_detail_id_,
			frrd.origin_result_,
			frrd.next_result_
		FROM
			fc_reconciliation_repair_detail frrd
		LEFT JOIN fc_reconciliation_details frd ON frrd.reconciliation_detail_id_ = frd.id_
		LEFT JOIN fc_reconciliation fr ON frrd.reconciliation_id_ = fr.id_
		WHERE
		 frrd.reconciliation_id_ = #{acceptID}
	</select>
	
	
	
<!-- 	被后日补录 -->
	<select id="reconciliationDetailsedPage" parameterType="Dto" resultType="Dto">
<!-- 		SELECT
			fr.reconciliation_date_,
			frrd.reconciliation_detail_id_,
			frrd.origin_result_,
			frrd.next_result_
		FROM
			fc_reconciliation_repair_detail frrd
		LEFT JOIN fc_reconciliation_details frd ON frrd.reconciliation_detail_id_ = frd.id_
		LEFT JOIN fc_reconciliation fr ON frrd.reconciliation_id_ = fr.id_
		WHERE  frrd.reconciliation_id_  = #{acceptID} -->
		SELECT
			frrd.they_settled_time_,
			frrd.reconciliation_detail_id_,
			frrd.origin_result_,
			frrd.next_result_
		FROM
			fc_reconciliation_repair_detail frrd
		WHERE  frrd.reconciliation_id_  = #{acceptID}
	
	</select>
<!-- 	划扣指令 -->
	<select id="instructionSetDetails" parameterType="Dto" resultType="Dto">
		SELECT
		  fro.id_,  <!--划扣指令ID -->
		  fro.chargeback_accepted_id_,  <!-- 指令起源（划扣受理ID） -->
		  fro.routed_third_channel_code_,  <!-- 路由去向code -->
		  fro.third_channel_order_id_,  <!-- 所涉订单号ID-->
		  fro.routed_third_channel_id_,  <!-- 路由去向（第三方支付ID）-->
		  fro.location_,  <!-- 指令位置 -->
		  fro.chargeback_amount_,  <!-- 划扣金额 -->
		  fro.chargeback_bank_id_,  <!--划扣账号所在银行ID -->
		  fro.chargeback_account_,  <!-- 划扣账号 -->
		  fro.chargeback_name_,  <!-- 划扣账号户主姓名 -->
		  fro.chargeback_idcard_,  <!-- 划扣账号户主身份证 -->
		  fro.chargeback_cellphone_,  <!--划扣账号预留手机 -->
		  fro.created_time_,  <!-- 数据创建时间 -->
		  fro.interact_times_,  <!-- 已与第三方交互次数 -->
		  fro.next_interact_time_,  <!-- 下次与第三方交互时间 -->
		  fcor.order_result_status_,  <!-- 指令结果状态 -->
		  fcor.trans_amount,  <!-- 交易金额-->
		  fcor.third_channel_fee_,  <!-- 第三方手续费 -->
		  fcor.third_channel_feedback_,  <!-- 第三方反馈摘要 -->
		  fcor.third_channel_return_code_,  <!-- 第三方返回码 -->
		  fcor.request_time,  <!-- 我方发给第三方的时间 -->
		  fcor.response_time_,  <!--第三方完成指令的时间 -->
		  fcor.bank_echo_time_  <!-- 银行响应第三方的时间 -->
		FROM
			fc_chargeback_order fro,
			fc_chargeback_order_result fcor
		WHERE fro.id_ = fcor.id_  and fro.third_channel_order_id_  = #{our_order_id_}
	
	</select>
	
	
<!-- 	指令发送情况 -->
	<select id="setInfoListPage" parameterType="Dto" resultType="Dto">
		SELECT
			id_,
			chargeback_order_id_,
			third_channel_order_id_,
			sent_time_,
			sent_status_,
			ext_context_
		FROM
			fc_chargeback_order_send
		WHERE
			1='1'
	AND third_channel_order_id_ = #{our_order_id_}
	</select>
	
	
	<!-- 指令核查情况 -->
	<select id="checkInfoListPage" parameterType="Dto" resultType="Dto">
		SELECT
			id_,  
			chargeback_order_id_,  
			third_channel_order_id_,  
			checked_time, 
			checked_status_,
			ext_context_ 
		FROM
			fc_chargeback_order_check 
		WHERE 1='1' and third_channel_order_id_  = #{our_order_id_}
	</select>
	
	
	<!-- 导出export 从数据库查询划扣数据-->
	<select id="reconciliationDetailsPayExportPage" parameterType="Dto" resultType="Dto">
		SELECT
			frd.id_,
			frd.order_id_,
			frd.reconciliation_id_,
			frd.third_channel_id_,
			frd.type_,
			frd.result_,
			frd.our_order_id_,
			frd.our_sent_time_,
			frd.our_trans_amount_,
			frd.our_third_channel_fee_,
			frd.they_order_id_,
			frd.they_settled_time_,
			frd.they_trans_amount_,
			frd.they_third_channel_fee_,
			frd.interference_status_,
			fr.reconciliation_date_,
			fco.chargeback_idcard_ as idcard_,
			fco.chargeback_name_ as name_,
			fco.chargeback_account_ as account_,
			fco.chargeback_bank_id_ as bank_id_,
			fb.full_name_
		FROM
			fc_reconciliation_details frd
		LEFT JOIN fc_reconciliation fr ON frd.reconciliation_id_ = fr.id_
		LEFT JOIN fc_chargeback_order fco ON fco.id_ = frd.order_id_
		LEFT JOIN fc_banks fb ON fb.id_ = fco.chargeback_bank_id_	
		WHERE
			1 = '1'
		AND frd.reconciliation_id_ = #{acceptID} order by frd.result_  ASC , frd.id_ ASC
	
	</select>  
	
	
	
	<!-- 导出export 从数据库查询放款数据 -->
	<select id="reconciliationDetailsLoanExportPage" parameterType="Dto" resultType="Dto">
		SELECT
			frd.id_,
			frd.order_id_,
			frd.reconciliation_id_,
			frd.third_channel_id_,
			frd.type_,
			frd.result_,
			frd.our_order_id_,
			frd.our_sent_time_,
			frd.our_trans_amount_,
			frd.our_third_channel_fee_,
			frd.they_order_id_,
			frd.they_settled_time_,
			frd.they_trans_amount_,
			frd.they_third_channel_fee_,
			frd.interference_status_,
			fr.reconciliation_date_,
			fco.loan_idcard_ as idcard_,
			fco.loan_name_ as name_,
			fco.loan_account_ as account_,
			fco.loan_bank_id_ as bank_id_,
			fb.full_name_
		FROM
			fc_reconciliation_details frd
		LEFT JOIN fc_reconciliation fr ON frd.reconciliation_id_ = fr.id_
		LEFT JOIN fc_loan_accepted_order fco ON fco.id_ = frd.order_id_
		LEFT JOIN fc_banks fb ON fb.id_ = fco.loan_bank_id_
		
		WHERE
			1 = '1'
		AND frd.reconciliation_id_ = #{acceptID} order by frd.result_  ASC , frd.id_ ASC
	
	</select> 
	
	
</mapper>