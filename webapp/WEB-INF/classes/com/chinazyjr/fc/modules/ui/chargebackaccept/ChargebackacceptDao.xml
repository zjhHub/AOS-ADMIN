<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" 
"http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="chargebackaccept">
	<select id="chargebackacceptPage" parameterType="Dto" resultType="Dto">
		SELECT
			fca.id_  AS chargeback_acceptedID,
			fca.request_id_,
			fca.location_,
			fth.id_ AS routed_third_channel_id_,
			IFNULL(fth.name_ ,'--') AS channel_name_,
			fca.contract_id_,
			fp.id_ AS platformId,
			fp.name_ AS platformName,
			fca.contract_code_,
			fca.chargeback_account_,
			fca.chargeback_name_,
			fca.chargeback_amount_,
			fca.created_time_,
			fcar.chargeback_status_
		FROM
			fc_chargeback_accepted fca
		LEFT JOIN fc_third_channel fth ON fca.routed_third_channel_id_ = fth.id_
		LEFT JOIN fc_platform fp ON fca.platform_id_ = fp.id_
		LEFT JOIN fc_chargback_accepted_result fcar ON fcar.chargeback_accepted_id_ = fca.id_
		WHERE 1=1
		<if test="chargeback_acceptedID != null and chargeback_acceptedID != ''">
			AND fca.id_ like '%${chargeback_acceptedID}%' <!--  -->
		</if>
		
		<if test="contract_id_ != null and contract_id_ != ''">
			AND fca.contract_id_ like '%${contract_id_}%'
		</if>
		
		<if test="request_id_ != null and request_id_ != ''">
			AND fca.request_id_ like '%${request_id_}%'
		</if>
		
		<if test="platformId != null and platformId != ''">
			AND fp.id_ = #{platformId}
		</if>
		
		<if test="location_ != null and location_ != ''">
			AND fca.location_ = #{location_}
		</if>

		<if test="contract_code_ != null and contract_code_ != ''">
			AND fca.contract_code_ like '%${contract_code_}%'
		</if>
		
		<if test="routed_third_channel_id_ != null and routed_third_channel_id_ != ''">
			AND fth.id_ = #{routed_third_channel_id_}
		</if>
		
		<if test="start_created_time_ != null and start_created_time_ !='' "> 
			AND fca.created_time_ <![CDATA[ >= ]]> #{start_created_time_}  <!-- 开始日期 -->
		</if>
		
		<if test="end_created_time_ != null and end_created_time_ !='' ">
			AND fca.created_time_ <![CDATA[ <= ]]> CONCAT(#{end_created_time_},' 23:59:59')  <!-- 结束日期 -->
		</if>
		
		ORDER BY fca.created_time_ DESC
		
	</select>
	
	
		<select id="chargebackacceptunusualPage" parameterType="Dto" resultType="Dto">
		SELECT
			fca.id_  AS chargeback_acceptedID,
			fca.request_id_,
			fca.location_,
			fth.id_ AS routed_third_channel_id_,
			IFNULL(fth.name_ ,'--') AS channel_name_,
			fca.contract_id_,
			fp.id_ AS platformId,
			fp.name_ AS platformName,
			fca.contract_code_,
			fca.chargeback_account_,
			fca.chargeback_name_,
			fca.chargeback_amount_,
			fca.created_time_,
			fcar.chargeback_status_
		FROM
			fc_chargeback_accepted fca
		LEFT JOIN fc_third_channel fth ON fca.routed_third_channel_id_ = fth.id_
		LEFT JOIN fc_platform fp ON fca.platform_id_ = fp.id_
		LEFT JOIN fc_chargback_accepted_result fcar ON fcar.chargeback_accepted_id_ = fca.id_
		WHERE fca.location_ > 4
		<if test="chargeback_acceptedID != null and chargeback_acceptedID != ''">
			AND fca.id_ like '%${chargeback_acceptedID}%' <!--  -->
		</if>
		
		<if test="contract_id_ != null and contract_id_ != ''">
			AND fca.contract_id_ like '%${contract_id_}%'
		</if>
		
		<if test="request_id_ != null and request_id_ != ''">
			AND fca.request_id_ like '%${request_id_}%'
		</if>
		
		<if test="platformId != null and platformId != ''">
			AND fp.id_ = #{platformId}
		</if>

		<if test="contract_code_ != null and contract_code_ != ''">
			AND fca.contract_code_ like '%${contract_code_}%'
		</if>
		
		<if test="routed_third_channel_id_ != null and routed_third_channel_id_ != ''">
			AND fth.id_ = #{routed_third_channel_id_}
		</if>
		
		<if test="start_created_time_ != null and start_created_time_ !='' "> 
			AND fca.created_time_ <![CDATA[ >= ]]> #{start_created_time_}  <!-- 开始日期 -->
		</if>
		
		<if test="end_created_time_ != null and end_created_time_ !='' ">
			AND fca.created_time_ <![CDATA[ <= ]]> CONCAT(#{end_created_time_},' 23:59:59')  <!-- 结束日期 -->
		</if>
		
		ORDER BY fca.created_time_ DESC
		
	</select>
	
	
	
	<!-- 受理详情 -->
	<select id="chargebackacceptDetails" parameterType="Dto" resultType="Dto">
		SELECT
			fca.id_,
			ftc.name_ thirdName,
			fca.chargeback_amount_,
			fca.request_id_,
			fca.chargeback_account_,
			fca.contract_id_,
			fca.chargeback_name_,
			fca.location_,
			fca.chargeback_idcard_,
			fp.name_,
			fca.chargeback_cellphone_,
			fca.biz_summary_,
			DATE_FORMAT(fca.created_time_,'%Y-%m-%d %H:%i:%S') created_time_,
			
			fca.contract_code_,
			IFNULL(a.fcocount,0) fcocount,
			fca.reference_,
			fca.async_callback_,
			fca.remark_,
			fcar.chargeback_status_,
			fcar.response_code_,
			fcar.chargebacked_amount_,
			fcar.response_summary_,
			fcar.response_msg_templet_,
			DATE_FORMAT(fcar.first_callback_time_,'%Y-%m-%d %H:%i:%S') first_callback_time_,
			
			fcar.callback_content_,
			fb.full_name_ AS chargeback_bank_id_
		FROM
			fc_chargeback_accepted fca
		LEFT JOIN fc_third_channel ftc ON fca.routed_third_channel_id_ = ftc.id_
		LEFT JOIN fc_chargback_accepted_result fcar ON fca.id_ = fcar.chargeback_accepted_id_
		LEFT JOIN fc_platform fp ON fca.platform_id_ = fp.id_
		LEFT JOIN fc_banks fb ON fb.id_ = fca.chargeback_bank_id_
		LEFT JOIN (
			SELECT
				count(*) AS fcocount,
				fco.chargeback_accepted_id_
			FROM
				fc_chargeback_order fco
			WHERE
				fco.chargeback_accepted_id_ = #{acceptedID}
		) a ON fca.id_ = a.chargeback_accepted_id_
		WHERE 1=1
		<if test="acceptedID != null and acceptedID !='' ">
			AND fca.id_ = #{acceptedID}
		</if>

	</select>
	
	<!-- 划扣指令 -->
	<select id="chargebackOrderList" parameterType="Dto" resultType="Dto">
		SELECT
			fco.id_,
			fco.chargeback_accepted_id_,
			fco.created_time_,
			fth.name_,
			fco.location_,
			fco.chargeback_amount_,
			fb.full_name_,
			fco.chargeback_account_,
			fco.chargeback_name_,
			fco.chargeback_idcard_,
			fco.chargeback_cellphone_,
			fco.third_channel_order_id_, 
			fco.interact_times_,
			fcor.order_result_status_,
			fcor.trans_amount,
			fcor.third_channel_fee_,
			fcor.third_channel_feedback_,
			fcor.third_channel_return_code_,
			fcor.request_time,
			fcor.response_time_,
			fcor.bank_echo_time_
		FROM
			fc_chargeback_order fco
		LEFT JOIN fc_chargeback_order_result fcor ON fco.id_ = fcor.id_
		LEFT JOIN fc_third_channel fth ON fco.routed_third_channel_id_ = fth.id_
		LEFT JOIN fc_banks fb ON fco.chargeback_bank_id_ = fb.id_
		WHERE 1=1
		<if test="acceptedID != null and acceptedID !='' ">
			AND fco.chargeback_accepted_id_ = #{acceptedID}
		</if>
	</select>
	
	<!-- 回调记录 -->
	<select id="chargebackAcceptedCallbackList" parameterType="Dto" resultType="Dto">
		SELECT
			fcac.id_,
			fcac.callback_status_,
			fcac.callback_time_,
			fcac.response_http_code_
		FROM
			fc_chargeback_accepted_callback fcac
		WHERE 1=1
		<if test="acceptedID != null and acceptedID !='' ">
			AND fcac.chargeback_accepted_id_ = #{acceptedID}
		</if>
			
	</select>
	
</mapper>