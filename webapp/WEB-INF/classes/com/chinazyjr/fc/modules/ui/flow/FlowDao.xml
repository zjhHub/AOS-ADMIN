<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" 
"http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<!-- -->
<mapper namespace="flow">
	<select id="flowPage" parameterType="Dto" resultType="Dto">
		SELECT
		IFNULL(fm.id_ ,'--') AS flow_moneyId ,
		a.flow_businessId,
		a.name_,
		a.contractId,
		a.contract_code_,
		a.summary_,
		a.occured_time_,
		a.request_uuid_,
		a.ip_address_,
		a.created_time_,
		a.id_
		FROM
		(
		SELECT
		ffb.id_ AS flow_businessId,
		fp.name_,
		fo.id_ AS contractId,
		fo.contract_code_,
		ffb.summary_,
		ffb.occured_time_,
		ffb.request_uuid_,
		fip.ip_address_,
		ffb.created_time_,
		fp.id_ 
		FROM
		fc_flow_business ffb,
		fc_platform fp,
		fc_contract fo,
		fc_ip_white_list fip
		WHERE
		ffb.platform_id_ = fp.id_
		AND ffb.contract_id_ = fo.id_
		AND ffb.created_by_ = fip.id_
		) a
		LEFT JOIN
		fc_flow_money fm
		ON
		a.flow_businessId = fm.flow_biz_id_
		WHERE 1=1
		<if test="flow_businessId != null and flow_businessId != ''">
			AND a.flow_businessId like '%${flow_businessId}%' <!-- -->
		</if>

		<if test="id_ != null and id_ != ''">
			AND a.id_ = #{id_}
		</if>
		<if test="request_uuid_ != null and request_uuid_ != ''">
			AND a.request_uuid_ like '%${request_uuid_}%'
		</if>

		<if test="summary_ != null and summary_ != ''">
			AND a.summary_ like '%${summary_}%'
		</if>

		<if test="flow_moneyId != null and flow_moneyId != ''">
			AND fm.id_ like '%${flow_moneyId}%'
		</if>

		<if test="start_time_ != null and start_time_ !='' ">
			AND a.created_time_ <![CDATA[ >= ]]>
			#{start_time_}  <!-- 开始日期 -->
		</if>

		<if test="end_time_!= null and end_time_ !='' ">
			AND a.created_time_ <![CDATA[ <= ]]>
			CONCAT(#{end_time_},' 23:59:59')  <!-- 结束日期 -->
		</if>

		<if test="contractId != null and contractId != ''">
			AND a.contractId like '%${contractId}%'
		</if>

		<if test="contract_code_ != null and contract_code_ != ''">
			AND a.contract_code_ like '%${contract_code_}%'
		</if>

	</select>

	<select id="subjectflowDetailPage" parameterType="Dto"
		resultType="Dto">
		SELECT
		fs.no_,
		ffc.name_,
		fbc.target_,
		fbc.before_amount_,
		fbc.changing_amount_,
		fbc.after_amount_,
		fbc.changing_date_
		FROM
		fc_book_change_log fbc,
		fc_financial_category ffc,
		fc_book_subject fbs,
		fc_staging fs
		WHERE
		fbc.category_id_ = ffc.id_
		AND
		fbc.record_id_ = fbs.id_
		AND
		fbs.staging_id_ = fs.id_
		AND
		fbc.book_type_ = 1 <!-- 1 冲销 2 截留 -->
		AND
		fbc.flow_biz_id_ = #{b_id_}

	</select>


	<select id="cutflowDetailPage" parameterType="Dto" resultType="Dto">
		SELECT
		ffc.name_,
		fbc.before_amount_,
		fbc.changing_amount_,
		fbc.after_amount_,
		fbc.changing_date_
		FROM
		fc_book_change_log fbc,
		fc_financial_category ffc
		WHERE
		fbc.category_id_ = ffc.id_
		AND
		fbc.book_type_ = 2 <!-- 1 冲销 2 截留 -->
		AND
		fbc.flow_biz_id_ = #{b_id_}
	</select>

	<select id="queryCount" parameterType="Dto" resultType="Dto">
		SELECT
		jscount,
		cscount
		FROM
		(
		SELECT
		count(1) jscount
		FROM
		fc_book_change_log fbc,
		fc_financial_category ffc,
		fc_book_subject fbs,
		fc_staging fs
		WHERE
		fbc.category_id_ = ffc.id_
		AND fbc.record_id_ = fbs.id_
		AND
		fbs.staging_id_ = fs.id_
		AND
		fbc.book_type_ = 1
		AND fbc.flow_biz_id_ =
		#{b_id_}
		) a,
		(
		SELECT
		count(1) cscount
		FROM
		fc_book_change_log fbc,
		fc_financial_category ffc
		WHERE
		fbc.category_id_ = ffc.id_
		AND
		fbc.book_type_ = 2
		AND fbc.flow_biz_id_ = #{b_id_}
		) b
	</select>

</mapper>